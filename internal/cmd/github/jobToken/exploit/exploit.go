package exploit

import (
	"github.com/CompassSecurity/pipeleek/pkg/config"
	pkgjobtoken "github.com/CompassSecurity/pipeleek/pkg/github/jobtoken"
	"github.com/rs/zerolog/log"
	"github.com/spf13/cobra"
)

func NewExploitCmd() *cobra.Command {
	var repo string

	exploitCmd := &cobra.Command{
		Use:     "exploit",
		Short:   "Validate GitHub Actions token and attempt repo clone",
		Long:    "Validate the GitHub Actions CI/CD token (GITHUB_TOKEN), then attempts to clone the repository using the token. The user must review the token's access scope manually for exploitation.",
		Example: "pipeleek gh jobToken exploit --token ghs-xxxxxxxxxxx --repo owner/repo",
		Run: func(cmd *cobra.Command, args []string) {
			if err := config.AutoBindFlags(cmd, map[string]string{
				"github": "github.url",
				"token":  "github.token",
				"repo":   "github.jobToken.exploit.repo",
			}); err != nil {
				log.Fatal().Err(err).Msg("Failed to bind command flags to configuration keys")
			}

			if err := config.RequireConfigKeys("github.url", "github.token", "github.jobToken.exploit.repo"); err != nil {
				log.Fatal().Err(err).Msg("required configuration missing")
			}

			githubUrl := config.GetString("github.url")
			githubToken := config.GetString("github.token")
			repo = config.GetString("github.jobToken.exploit.repo")

			if repo == "" {
				log.Fatal().Msg("Repository is required (use --repo flag, config file, or PIPELEEK_GITHUB_JOBTOKEN_EXPLOIT_REPO env var)")
			}

			if err := config.ValidateURL(githubUrl, "GitHub URL"); err != nil {
				log.Fatal().Err(err).Msg("Invalid GitHub URL")
			}
			if err := config.ValidateToken(githubToken, "GitHub Actions Token"); err != nil {
				log.Fatal().Err(err).Msg("Invalid GitHub Actions Token")
			}

			pkgjobtoken.Run(githubUrl, githubToken, repo)
			log.Info().Msg("Done, Bye Bye")
		},
	}

	exploitCmd.Flags().StringVarP(&repo, "repo", "r", "", "Repository in format owner/repo")

	return exploitCmd
}
