package exploit

import (
	"github.com/CompassSecurity/pipeleek/pkg/config"
	pkgrunners "github.com/CompassSecurity/pipeleek/pkg/gitlab/runners/exploit"
	"github.com/rs/zerolog/log"
	"github.com/spf13/cobra"
)

func NewRunnersExploitCmd() *cobra.Command {
	var runnerTags []string
	var ageEncryptionPublicKey string
	var repoName string
	var dry bool
	var shell bool

	exploitCmd := &cobra.Command{
		Use:   "exploit",
		Short: "Create project with CI/CD jobs to exploit available runners",
		Long:  "Creates a project, generates a job per available runner tag and runs a default .gitlab-Ci.yml definition which can be customized for exploitation.",
		Example: `
# Creates a project with jobs for all available runners with the tags docker, shared. Dumps the envs encrypted using Age and starts an interactive SSHX shell,
pipeleek gl runners exploit --token glpat-xxxxxxxxxxx --gitlab https://gitlab.mydomain.com --tags docker,shared --age-public-key age1... --repo-name my-exploit-repo --dry=false --shell=true

# Print the generated .gitlab-ci.yml only, does NOT create a project or jobs (gitlab and token flags not required)
pipeleek gl runners exploit --dry=true --shell=true
 		`,
		Run: func(cmd *cobra.Command, args []string) {
			if err := config.AutoBindFlags(cmd, map[string]string{
				"gitlab":         "gitlab.url",
				"token":          "gitlab.token",
				"tags":           "gitlab.runners.exploit.tags",
				"age-public-key": "gitlab.runners.exploit.age_public_key",
				"repo-name":      "gitlab.runners.exploit.repo_name",
				"dry":            "gitlab.runners.exploit.dry",
				"shell":          "gitlab.runners.exploit.shell",
			}); err != nil {
				log.Fatal().Err(err).Msg("Failed to bind command flags to configuration keys")
			}

			// Get values from config (supports CLI flags, config file, and env vars)
			runnerTags = config.GetStringSlice("gitlab.runners.exploit.tags")
			ageEncryptionPublicKey = config.GetString("gitlab.runners.exploit.age_public_key")
			repoName = config.GetString("gitlab.runners.exploit.repo_name")
			dry = config.GetBool("gitlab.runners.exploit.dry")
			shell = config.GetBool("gitlab.runners.exploit.shell")

			// Only require gitlab URL and token when not in dry-run mode
			if !dry {
				if err := config.RequireConfigKeys("gitlab.url", "gitlab.token"); err != nil {
					log.Fatal().Err(err).Msg("required configuration missing")
				}

				gitlabUrl := config.GetString("gitlab.url")
				gitlabApiToken := config.GetString("gitlab.token")

				if err := config.ValidateURL(gitlabUrl, "GitLab URL"); err != nil {
					log.Fatal().Err(err).Msg("Invalid GitLab URL")
				}
				if err := config.ValidateToken(gitlabApiToken, "GitLab API Token"); err != nil {
					log.Fatal().Err(err).Msg("Invalid GitLab API Token")
				}

				pkgrunners.ExploitRunners(runnerTags, dry, shell, gitlabApiToken, gitlabUrl, ageEncryptionPublicKey, repoName)
			} else {
				// In dry-run mode, we don't need gitlab URL and token
				pkgrunners.ExploitRunners(runnerTags, dry, shell, "", "", ageEncryptionPublicKey, repoName)
			}

			log.Info().Msg("Done, Bye Bye üè≥Ô∏è‚Äçüåàüî•")
		},
	}

	exploitCmd.Flags().StringSliceVarP(&runnerTags, "tags", "", []string{}, "Jobs with the following tags are created")
	exploitCmd.Flags().StringVarP(&ageEncryptionPublicKey, "age-public-key", "", "", "An age public key generated with ./age-keygen -o key.txt (repo: https://github.com/FiloSottile/age). Prints the encrypted environment variables in the output log.")
	exploitCmd.Flags().StringVarP(&repoName, "repo-name", "", "pipeleek-runner-test", "The name for the created repository")
	exploitCmd.PersistentFlags().BoolVarP(&dry, "dry", "d", false, "Only generate and print the .gitlab-ci.yml, do NOT create real jobs")
	exploitCmd.PersistentFlags().BoolVarP(&shell, "shell", "s", true, "Add an SSHX interactive shell to the jobs")

	return exploitCmd
}
