//go:build e2e

package e2e

import (
	"encoding/json"
	"net/http"
	"os"
	"strings"
	"testing"
	"time"

	"github.com/CompassSecurity/pipeleek/tests/e2e/internal/testutil"
	"github.com/stretchr/testify/assert"
)

func TestGHGhTokenExploit_HappyPath(t *testing.T) {
	server, getRequests, cleanup := testutil.StartMockServerWithRecording(t, func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Content-Type", "application/json")

		// Handle repository get (GitHub Enterprise path)
		if strings.HasPrefix(r.URL.Path, "/api/v3/repos/") && !strings.Contains(r.URL.Path, "/git/") {
			w.WriteHeader(http.StatusOK)
			_ = json.NewEncoder(w).Encode(map[string]interface{}{
				"id":             456,
				"name":           "testrepo",
				"full_name":      "testowner/testrepo",
				"default_branch": "main",
				"visibility":     "private",
				"html_url":       "https://github.com/testowner/testrepo",
				"clone_url":      "https://github.com/testowner/testrepo.git",
			})
			return
		}

		w.WriteHeader(http.StatusNotFound)
		_ = json.NewEncoder(w).Encode(map[string]string{"message": "Not Found"})
	})
	defer cleanup()

	cwd, err := os.Getwd()
	if err != nil {
		t.Fatalf("failed to get working dir: %v", err)
	}
	tmpDir, err := os.MkdirTemp(cwd, "ghtoken-e2e-")
	if err != nil {
		t.Fatalf("failed to create temp dir: %v", err)
	}
	defer func() {
		_ = os.Chdir(cwd)
		_ = os.RemoveAll(tmpDir)
	}()
	if err := os.Chdir(tmpDir); err != nil {
		t.Fatalf("failed to chdir: %v", err)
	}

	stdout, stderr, exitErr := testutil.RunCLI(t, []string{
		"gh", "ghtoken", "exploit",
		"--github", server.URL,
		"--token", "ghs_test_token",
		"--repo", "testowner/testrepo",
	}, nil, 10*time.Second)

	if exitErr != nil {
		t.Logf("Exit error: %v", exitErr)
		t.Logf("Stdout: %s", stdout)
		t.Logf("Stderr: %s", stderr)
	}

	assert.Nil(t, exitErr, "ghtoken exploit should succeed")
	assert.Contains(t, stdout+stderr, "GitHub Actions token validation succeeded")

	requests := getRequests()
	assert.True(t, len(requests) >= 1, "expected at least one repo API call")

	// Verify repo authentication call was made (GitHub Enterprise path)
	hasRepoCall := false
	for _, req := range requests {
		if strings.HasPrefix(req.Path, "/api/v3/repos/testowner/testrepo") {
			hasRepoCall = true
		}
	}
	assert.True(t, hasRepoCall, "expected /api/v3/repos/testowner/testrepo API call")
}

func TestGHGhTokenExploit_MissingRepo(t *testing.T) {
	stdout, stderr, exitErr := testutil.RunCLI(t, []string{
		"gh", "ghtoken", "exploit",
		"--github", "https://api.github.com",
		"--token", "ghs_test_token",
	}, nil, 5*time.Second)

	assert.NotNil(t, exitErr, "should fail without repo")
	assert.Contains(t, stdout+stderr, "required configuration missing")
}

func TestGHGhTokenExploit_InvalidTokenFormat(t *testing.T) {
	server, _, cleanup := testutil.StartMockServerWithRecording(t, func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Content-Type", "application/json")
		w.WriteHeader(http.StatusUnauthorized)
		_ = json.NewEncoder(w).Encode(map[string]string{
			"message": "Bad credentials",
		})
	})
	defer cleanup()

	stdout, stderr, exitErr := testutil.RunCLI(t, []string{
		"gh", "ghtoken", "exploit",
		"--github", server.URL,
		"--token", "invalid_token",
		"--repo", "testowner/testrepo",
	}, nil, 5*time.Second)

	assert.NotNil(t, exitErr, "should fail with invalid token")
	assert.Contains(t, stdout+stderr, "Repo API access blocked")
}

func TestGHGhTokenExploit_RepositoryNotFound(t *testing.T) {
	server, _, cleanup := testutil.StartMockServerWithRecording(t, func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Content-Type", "application/json")

		if strings.HasPrefix(r.URL.Path, "/api/v3/repos/") {
			w.WriteHeader(http.StatusNotFound)
			_ = json.NewEncoder(w).Encode(map[string]string{
				"message": "Not Found",
			})
			return
		}

		w.WriteHeader(http.StatusNotFound)
	})
	defer cleanup()

	stdout, stderr, exitErr := testutil.RunCLI(t, []string{
		"gh", "ghtoken", "exploit",
		"--github", server.URL,
		"--token", "ghs_test_token",
		"--repo", "nonexistent/repo",
	}, nil, 5*time.Second)

	assert.NotNil(t, exitErr, "should fail with non-existent repo")
	assert.Contains(t, stdout+stderr, "Repo API access blocked")
}
